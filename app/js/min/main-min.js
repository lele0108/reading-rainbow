var scotchApp=angular.module("readingRainbow",["ngRoute"]);scotchApp.config(function(e){e.when("/",{templateUrl:"views/index.html",controller:"homeController"}).when("/read",{templateUrl:"views/read.html",controller:"readController"})}),scotchApp.filter("unsafe",function(e){return e.trustAsHtml}),scotchApp.controller("homeController",function(e,o,r){e.search=function(){$(".hello").append('<a href="book.html?search='+e.query+'"><button class="fuckme">Hi</button></a>'),$(".fuckme").click()},r.get("http://reading-rainbow.herokuapp.com/api/popular").success(function(o,r,n,t){e.popular=o}).error(function(e,o,r,n){})}),scotchApp.controller("bookController",function(e,o,r){var n=o.absUrl(),t;e.search=n.substring(n.search("search=")+7),console.log(e.search),r.post("http://reading-rainbow.herokuapp.com/api/search",{query:e.search}).success(function(o,r,n,a){e.book=o,t=o,console.log(o)}).error(function(e,o,r,n){}),e.query,e.request=require("request"),e.Q=require("q"),e.fs=require("fs"),e.kickass=require("kickass-search"),e.download=function(){var o=require("webtorrent"),r=new o,n;console.log(e.book.magnet_link),r.download(t.magnet_link,function(o){console.log("Torrent info hash:",o.infoHash),o.files.forEach(function(o){function r(){var r=e.Q.defer(),n=o.createReadStream();console.log("ghnghn");var t=e.fs.createWriteStream(o.name);return r.resolve(n.pipe(t)),r.promise}console.log(o.name),o.name.indexOf("epub")>=0&&(r().then(function(e){console.log(e),$(".hello").append('<a href="read.html?name='+o.name+'"><button class="fuckme">Hi</button></a>'),$(".fuckme").click()}),console.log("done"))})})},e.mostSeeders=function(o){if(!o||0==o.length)return console.log("ERROR"),null;var r=e.Q.defer();return e.compareSeeds(o).then(function(e){r.resolve(e)}),r.promise},e.compareSeeds=function(o){for(var r=e.Q.defer(),n=o[0],t=1;t<o.length;t++)parseInt(n.seed)<parseInt(o[t].seed)&&(n=o[t]);return r.resolve(n),r.promise}}),scotchApp.controller("readController",function(e,o){var r=o.absUrl();e.bookName=r.substring(r.search("name=")+5);var n=r.substring(r.search("name=")+5);n=decodeURI(n),console.log(n),e.bookName=n,console.log(e.bookName),e.page=0,outerScope=e,e.readEPub=function(o){console.log(e.bookName);var r=require("epub"),n=new r(e.bookName,"/imagewebroot/","/articlewebroot/");n.on("error",function(e){throw console.log("ERROR\n-----"),e;location.reload()}),n.on("end",function(){n.getChapter(n.spine.contents[e.page].id,function(e,o){return outerScope.text="aa",e?void console.log(e):(outerScope.text=o,void outerScope.$apply())})}),n.parse()},setTimeout(e.readEPub(),2e4)});